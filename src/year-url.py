import pandas as pd
import xlsxwriter
import newspaper
from newspaper import Article
import re
file_name = "year-url.xlsx"
workbook = xlsxwriter.Workbook(file_name)

worksheet = workbook.add_worksheet('sheet1')

worksheet.write(0, 0, 'malware_name')
worksheet.write(0,1,'year')


def func(pattern,text):
    for i in pattern:
        if i in text:
            return i
    return False

years = []
for year in range(2001,2020):
    years.append(str(year))

df = pd.read_excel('Malware_name.xlsx')
malware_name = df.values[:,0]
name_year = {}
for name in malware_name:
    name_year[name] = []
for i in range(1,63):
    readDir = "../url_filter/"+str(i)+".txt"
    f  = open(readDir,"r",encoding ='ANSI',errors = 'ignore')
    num = 1
    for url in f:
        if num ==10:
                break
        num +=1
        url = url.strip('\n')
        print(i,url)
        try:
                news = Article(url, language='en')
                news.download()
                news.parse()
                text  =  re.split("[.\n]",news.text)
                for tt in text:
                        year = func(years,tt)
                        name = func(malware_name,tt)
                        if year and name:
                                name_year[name].append(year)
        except newspaper.article.ArticleException as e:
                print(e)
        
row = 1
for name in malware_name:
        #print(name)
        a = name_year[name]
        if len(a)!=0:
                worksheet.write_row(row,0,[name,max(set(a),key = a.count)])
                print(name,max(set(a),key = a.count))
                row+=1
workbook.close()
